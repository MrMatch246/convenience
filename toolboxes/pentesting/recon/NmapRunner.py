import argparse
import subprocess
from pathlib import Path
from toolboxes.pentesting.utils import *

def run_leftover_finder(project_folder):
    project_folder = Path(project_folder)
    recon_dir = project_folder / "recon/stage_2"
    chunks_dir = recon_dir / "chunks"
    processed_dir = recon_dir / "processed_chunks"
    processed_dir.mkdir(parents=True, exist_ok=True)

    for chunk_file in chunks_dir.glob("*.txt"):
        chunk_name = chunk_file.stem.replace("leftover_hosts_", "")
        output_gnmap = processed_dir / f"found_quick_leftover_hosts_{chunk_name}.gnmap"
        if output_gnmap.exists():
            continue

        cmd = f"nmap -sn -n -Pn --top-ports 100 -iL {chunk_file} -oG {output_gnmap}"
        subprocess.run(cmd, shell=True, check=True)

    # Merge GNMAP results
    merged_file = recon_dir / "found_quick_leftover_hosts.txt"
    with open(merged_file, "w") as merged:
        for gnmap_file in processed_dir.glob("*.gnmap"):
            for line in open(gnmap_file):
                if "Status: Up" in line:
                    merged.write(line.split()[1] + "\n")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--project", required=True, help="Path to project folder")
    args = parser.parse_args()
    run_leftover_finder(args.project)
